---
const pathname = Astro.url.pathname;
---

<header transition:persist transition:animate="none">
  <nav class="container">
    <a href="/" class="logo">shavkatov.io</a>
    <div class="nav-right">
      <button class="lang-btn" id="langToggle" aria-label="Switch language">ðŸ‡ºðŸ‡¿</button>
      <div class="nav-socials">
        <button class="social-btn" data-url="https://t.me/shavkatovio" data-name="Telegram" aria-label="Telegram">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.2 4.4L2.4 10.9c-.6.2-.6.7 0 .9l4.8 1.5 1.8 5.8c.2.5.7.5.9.2l2.6-2.7 5.1 3.8c.5.4 1 .2 1.1-.4L22.3 5.3c.2-.7-.4-1.2-1.1-.9z"/>
            <path d="M9.2 13.3l8.4-6.2"/>
          </svg>
        </button>
        <button class="social-btn" data-url="https://instagram.com/shavkatov.io" data-name="Instagram" aria-label="Instagram">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="20" rx="5"/>
            <circle cx="12" cy="12" r="5"/>
            <circle cx="17.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/>
          </svg>
        </button>
      </div>
    </div>
  </nav>
</header>

<!-- Social confirm modal â€” body ichida, header tashqarisida -->
<div class="modal-overlay" id="socialModal">
  <div class="modal">
    <p><span id="modalPrefix"></span><span id="modalName"></span><span id="modalSuffix">ga o'tasizmi?</span></p>
    <div class="modal-actions">
      <button id="modalCancel">Yo'q</button>
      <a id="modalConfirm" href="#" target="_blank" rel="noopener noreferrer">Ha</a>
    </div>
  </div>
</div>

<script>
  // Barcha eventlar document delegation orqali â€” persist dublikat muammosini hal qiladi
  if (!(window as any).__headerListenersReady) {
    (window as any).__headerListenersReady = true;

    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const btn = target.closest('.social-btn') as HTMLElement;
      const modal = document.getElementById('socialModal');

      // Social button bosilganda
      if (btn) {
        const url = btn.dataset.url!;
        const name = btn.dataset.name!;
        const lang = localStorage.getItem('lang') || 'uz';
        const modalName = document.getElementById('modalName');
        const modalPrefix = document.getElementById('modalPrefix');
        const modalSuffix = document.getElementById('modalSuffix');
        const modalCancel = document.getElementById('modalCancel');
        const modalConfirm = document.getElementById('modalConfirm') as HTMLAnchorElement;
        if (modal && modalName && modalConfirm && modalPrefix && modalSuffix && modalCancel) {
          modalPrefix.textContent = lang === 'en' ? 'Open ' : '';
          modalName.textContent = name;
          modalSuffix.textContent = lang === 'en' ? '?' : 'ga o\'tasizmi?';
          modalCancel.textContent = lang === 'en' ? 'No' : 'Yo\'q';
          modalConfirm.textContent = lang === 'en' ? 'Yes' : 'Ha';
          modalConfirm.href = url;
          modal.classList.add('open');
        }
        return;
      }

      // Modal yopish
      if (modal && (target.id === 'modalCancel' || target === modal || target.id === 'modalConfirm')) {
        modal.classList.remove('open');
        return;
      }

      // Language toggle
      if (target.id === 'langToggle' || target.closest('#langToggle')) {
        const langBtn = document.getElementById('langToggle')!;
        const current = localStorage.getItem('lang') || 'uz';
        const next = current === 'en' ? 'uz' : 'en';
        localStorage.setItem('lang', next);
        langBtn.textContent = next === 'en' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡ºðŸ‡¿';
        document.dispatchEvent(new CustomEvent('langchange', { detail: next }));
      }
    });
  }

  // Sahifa yuklanganda til emoji ni to'g'rilash
  const langBtn = document.getElementById('langToggle');
  if (langBtn) {
    langBtn.textContent = (localStorage.getItem('lang') || 'uz') === 'en' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡ºðŸ‡¿';
  }
</script>

<style>
  header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 1.25rem 0;
    z-index: 50;
    background: #000000;
    backdrop-filter: blur(20px);
  }

  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    font-weight: 500;
    font-size: 1.1rem;
    color: #888888;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .lang-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    font-size: 1rem;
    line-height: 1;
    filter: grayscale(1);
    opacity: 0.6;
    transition: opacity 0.2s ease, filter 0.2s ease;
  }

  .lang-btn:hover {
    opacity: 1;
    filter: grayscale(0.5);
  }

  .nav-socials {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .social-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    color: #888888;
    transition: color 0.2s ease;
    display: flex;
    align-items: center;
  }

  .social-btn:hover {
    color: var(--color-text);
  }

  /* Modal */
  :global(.modal-overlay) {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  :global(.modal-overlay.open) {
    opacity: 1;
    pointer-events: auto;
  }

  :global(.modal) {
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 10px;
    padding: 1.25rem 1.75rem;
    background: #000000;
    text-align: center;
    max-width: 260px;
    width: 90%;
  }

  :global(.modal p) {
    color: #888888;
    font-size: 0.9rem;
    margin: 0 0 1rem;
  }

  :global(.modal #modalName) {
    color: var(--color-text);
  }

  :global(.modal-actions) {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }

  :global(.modal-actions button),
  :global(.modal-actions a) {
    font-family: 'Poppins', system-ui, sans-serif;
    font-size: 0.8rem;
    padding: 0.35rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  :global(#modalCancel) {
    background: none;
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #888888;
  }

  :global(#modalCancel:hover) {
    border-color: rgba(255, 255, 255, 0.15);
    color: var(--color-text);
  }

  :global(#modalConfirm) {
    background: rgba(255, 255, 255, 0.06);
    border: none;
    color: var(--color-text);
  }

  :global(#modalConfirm:hover) {
    background: rgba(255, 255, 255, 0.12);
  }
</style>
